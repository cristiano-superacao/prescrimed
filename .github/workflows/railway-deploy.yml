name: Deploy to Railway (backend & client)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy-backend:
    name: Backend API
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Railway Login (Token)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "RAILWAY_TOKEN secret não definido"; exit 1;
          fi
          railway login --token "$RAILWAY_TOKEN"

      - name: Link Project/Service (optional)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID_BACKEND: ${{ secrets.RAILWAY_SERVICE_ID_BACKEND }}
        run: |
          if [ ! -z "$RAILWAY_PROJECT_ID" ] && [ ! -z "$RAILWAY_SERVICE_ID_BACKEND" ]; then
            railway link --project "$RAILWAY_PROJECT_ID" --service "$RAILWAY_SERVICE_ID_BACKEND"
          else
            echo "Usando link existente/local do projeto (sem IDs)"
          fi

      - name: Deploy Backend
        run: |
          railway up

      - name: Health Check
        run: |
          # Tenta checar /health após deploy (URL pública esperada via variável)
          API_URL="${{ vars.RAILWAY_BACKEND_URL }}"
          if [ -z "$API_URL" ]; then
            echo "RAILWAY_BACKEND_URL não definido em repo variables; pulando healthcheck"; exit 0;
          fi
          echo "Checando saúde em $API_URL/health"
          curl -s "$API_URL/health" | tee health.json
          if cat health.json | grep -q '"db":"connected"'; then
            echo "Saúde OK"
          else
            echo "Aviso: DB não conectado (verifique MONGODB_URI no Railway)"; exit 0;
          fi

  deploy-client:
    name: Frontend Client
    runs-on: ubuntu-latest
    needs: deploy-backend
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Railway CLI
        run: npm i -g @railway/cli

      - name: Railway Login (Token)
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -z "$RAILWAY_TOKEN" ]; then
            echo "RAILWAY_TOKEN secret não definido"; exit 1;
          fi
          railway login --token "$RAILWAY_TOKEN"

      - name: Link Project/Service (optional)
        env:
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
          RAILWAY_SERVICE_ID_CLIENT: ${{ secrets.RAILWAY_SERVICE_ID_CLIENT }}
        run: |
          cd client
          if [ ! -z "$RAILWAY_PROJECT_ID" ] && [ ! -z "$RAILWAY_SERVICE_ID_CLIENT" ]; then
            railway link --project "$RAILWAY_PROJECT_ID" --service "$RAILWAY_SERVICE_ID_CLIENT"
          else
            echo "Usando link existente/local do projeto (sem IDs)"
          fi

      - name: Inject Frontend Env
        run: |
          cd client
          echo "VITE_API_URL=${{ secrets.VITE_API_URL }}" >> .env.production
          echo "VITE_BACKEND_ROOT=${{ secrets.VITE_BACKEND_ROOT }}" >> .env.production

      - name: Deploy Client
        run: |
          cd client
          railway up